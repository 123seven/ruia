
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="An async web scraping micro-framework based on asyncio.">
      
      
      
        <meta name="author" content="howie.hu">
      
      
        <link rel="canonical" href="https://docs.python-ruia.org/en/tutorials/spider.html">
      
      <link rel="icon" href="../../images/favicon.ico">
      <meta name="generator" content="mkdocs-1.2.3, mkdocs-material-7.3.5">
    
    
      
        <title>4. Spider Control - Ruia</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.cdeb8541.min.css">
      
        
        <link rel="stylesheet" href="../../assets/stylesheets/palette.3f5d1f46.min.css">
        
      
    
    
    
      
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback">
        <style>:root{--md-text-font-family:"Roboto";--md-code-font-family:"Roboto Mono"}</style>
      
    
    
    
    
      


    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="" data-md-color-primary="none" data-md-color-accent="none">
  
    
    <script>function __prefix(e){return new URL("../..",location).pathname+"."+e}function __get(e,t=localStorage){return JSON.parse(t.getItem(__prefix(e)))}</script>
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#spider-control" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../../index.html" title="Ruia" class="md-header__button md-logo" aria-label="Ruia" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Ruia
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              4. Spider Control
            
          </span>
        </div>
      </div>
    </div>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
      </label>
      
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" aria-label="Clear" tabindex="-1">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        
<a href="https://github.com/howie6879/ruia/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    howie6879/ruia
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../../index.html" title="Ruia" class="md-nav__button md-logo" aria-label="Ruia" data-md-component="logo">
      
  <img src="../../images/logo.png" alt="logo">

    </a>
    Ruia
  </label>
  
    <div class="md-nav__source">
      
<a href="https://github.com/howie6879/ruia/" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    howie6879/ruia
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../../index.html" class="md-nav__link">
        Introduction
      </a>
    </li>
  

    
      
      
      

  
  
  
    <li class="md-nav__item">
      <a href="../quickstart.html" class="md-nav__link">
        Quick Start
      </a>
    </li>
  

    
      
      
      

  
  
    
  
  
    
    <li class="md-nav__item md-nav__item--active md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_3" type="checkbox" id="__nav_3" checked>
      
      
      
      
        <label class="md-nav__link" for="__nav_3">
          Tutorials
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Tutorials" data-md-level="1">
        <label class="md-nav__title" for="__nav_3">
          <span class="md-nav__icon md-icon"></span>
          Tutorials
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="overview.html" class="md-nav__link">
        1. Overview
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="installation.html" class="md-nav__link">
        2. Installation
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="item.html" class="md-nav__link">
        3. Define Data Items
      </a>
    </li>
  

            
          
            
              
  
  
    
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" data-md-toggle="toc" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          4. Spider Control
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="spider.html" class="md-nav__link md-nav__link--active">
        4. Spider Control
      </a>
      
        


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#normalize-your-code" class="md-nav__link">
    Normalize your code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#send-further-requests" class="md-nav__link">
    Send Further Requests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concurrency-control" class="md-nav__link">
    Concurrency Control
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-middleware" class="md-nav__link">
    Use Middleware
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-plugin" class="md-nav__link">
    Use Plugin
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="request.html" class="md-nav__link">
        5. Request & Response
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="middleware.html" class="md-nav__link">
        6. Customize Middleware
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="plugins.html" class="md-nav__link">
        7. Write a Plugins
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_4" type="checkbox" id="__nav_4" >
      
      
      
      
        <label class="md-nav__link" for="__nav_4">
          API Guide
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="API Guide" data-md-level="1">
        <label class="md-nav__title" for="__nav_4">
          <span class="md-nav__icon md-icon"></span>
          API Guide
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../apis/field.html" class="md-nav__link">
        Field
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../apis/item.html" class="md-nav__link">
        Item
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../apis/spider.html" class="md-nav__link">
        Spider
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../apis/request.html" class="md-nav__link">
        Request
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../apis/response.html" class="md-nav__link">
        Response
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../apis/middleware.html" class="md-nav__link">
        Middleware
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_5" type="checkbox" id="__nav_5" >
      
      
      
      
        <label class="md-nav__link" for="__nav_5">
          Topics
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Topics" data-md-level="1">
        <label class="md-nav__title" for="__nav_5">
          <span class="md-nav__icon md-icon"></span>
          Topics
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../topics/write_spiders_like_scrapy.html" class="md-nav__link">
        Write Spiders like Scrapy
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../topics/item_data_cleaning.html" class="md-nav__link">
        Item Data Cleaning
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
      
      
      

  
  
  
    
    <li class="md-nav__item md-nav__item--nested">
      
      
        <input class="md-nav__toggle md-toggle" data-md-toggle="__nav_6" type="checkbox" id="__nav_6" >
      
      
      
      
        <label class="md-nav__link" for="__nav_6">
          Examples
          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <nav class="md-nav" aria-label="Examples" data-md-level="1">
        <label class="md-nav__title" for="__nav_6">
          <span class="md-nav__icon md-icon"></span>
          Examples
        </label>
        <ul class="md-nav__list" data-md-scrollfix>
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/project.html" class="md-nav__link">
        Full featured project
      </a>
    </li>
  

            
          
            
              
  
  
  
    <li class="md-nav__item">
      <a href="../examples/spider_parent_class.html" class="md-nav__link">
        Parent Class For Your Spider
      </a>
    </li>
  

            
          
        </ul>
      </nav>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#normalize-your-code" class="md-nav__link">
    Normalize your code
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#send-further-requests" class="md-nav__link">
    Send Further Requests
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#concurrency-control" class="md-nav__link">
    Concurrency Control
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-middleware" class="md-nav__link">
    Use Middleware
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#use-plugin" class="md-nav__link">
    Use Plugin
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content" data-md-component="content">
            <article class="md-content__inner md-typeset">
              
                
                  <a href="https://github.com/howie6879/ruia/edit/master/docs/en/tutorials/spider.md" title="Edit this page" class="md-content__button md-icon">
                    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg>
                  </a>
                
                
                <h1 id="spider-control">Spider Control</h1>
<p><code>ruia.Spider</code> is used to control the whole spider,
it provides the following functions:</p>
<ul>
<li>Normalize your code</li>
<li>Maintain a event loop</li>
<li>Manage requests and responses</li>
<li>Concurrency control</li>
<li>Manage middlewares and plugins</li>
</ul>
<p>Although it works well,
to use only <code>ruia.Item</code> to create a spider,
<code>ruia</code> recommend to use <code>ruia.Spider</code> to implement a stronger spider.</p>
<h2 id="normalize-your-code">Normalize your code</h2>
<p><code>ruia.Spider</code> requires a class property <code>start_urls</code> as the entry point of a spider.
Inner, <code>ruia</code> will iterate <code>start_urls</code>,
and send a request to server for each request.
After receiving server response,
<code>ruia</code> will call <code>spider.parse(response)</code>,
and this is the main part of your spider.</p>
<p>Here's a simple parse example, to simply save response fields to a text file.
We only have to define <code>start_urls</code>,
and implement a <code>parse</code> method.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">aiofiles</span>

<span class="kn">from</span> <span class="nn">ruia</span> <span class="kn">import</span> <span class="n">Spider</span><span class="p">,</span> <span class="n">Item</span><span class="p">,</span> <span class="n">TextField</span><span class="p">,</span> <span class="n">AttrField</span>


<span class="k">class</span> <span class="nc">HackerNewsItem</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="n">target_item</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;tr.athing&#39;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;a.storylink&#39;</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">AttrField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;a.storylink&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;href&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HackerNewsSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;https://news.ycombinator.com/news?p=</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">HackerNewsItem</span><span class="o">.</span><span class="n">get_items</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()):</span>
            <span class="k">yield</span> <span class="n">item</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">HackerNewsItem</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ruia build-in method&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiofiles</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;./hacker_news.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">title</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</code></pre></div>

<p><code>aiofiles</code> is a third-party library to operate files in asynchronous way.
It provides APIs the same as python standard <code>open</code> function.</p>
<p>Now, we have written a spider,
and time to start crawling.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">aiofiles</span>

<span class="kn">from</span> <span class="nn">ruia</span> <span class="kn">import</span> <span class="n">Spider</span><span class="p">,</span> <span class="n">Item</span><span class="p">,</span> <span class="n">TextField</span><span class="p">,</span> <span class="n">AttrField</span>


<span class="k">class</span> <span class="nc">HackerNewsItem</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="n">target_item</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;tr.athing&#39;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;a.storylink&#39;</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">AttrField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;a.storylink&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;href&#39;</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">HackerNewsSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;https://news.ycombinator.com/news?p=</span><span class="si">{</span><span class="n">index</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">)]</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">HackerNewsItem</span><span class="o">.</span><span class="n">get_items</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()):</span>
            <span class="k">yield</span> <span class="n">item</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">process_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">item</span><span class="p">:</span> <span class="n">HackerNewsItem</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Ruia build-in method&quot;&quot;&quot;</span>
        <span class="k">async</span> <span class="k">with</span> <span class="n">aiofiles</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;./hacker_news.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="k">await</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">title</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">HackerNewsSpider</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>

<p>Done.
Now your code is more readable and maintainable.</p>
<h2 id="send-further-requests">Send Further Requests</h2>
<p>I don't think that just crawling the catalogue of news satisfied you.
Next we will crawl news itself.
Hacker news gathers news from many websites,
it's not easy to parse each article of it.
For this example, we'll crawl <a href="https://developer.github.com/v3/">Github Developer Documentation</a>.</p>
<p>If you are a user of <code>scrapy</code>, perhaps you'd like this essay for migration:
<a href="../topics/write_spiders_like_scrapy.html">Write Spiders like Scrapy</a>.</p>
<p><code>Ruia</code> provides a better way to send further requests by new asynchronous syntax async/await.
It provides more readability and is more flexible.
In any parse method, just <code>yield</code> a coroutine, and the coroutine will be processed by <code>ruia</code>.</p>
<p>Here is a simple pseudo-code.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">ruia</span> <span class="kn">import</span> <span class="n">Spider</span>


<span class="k">class</span> <span class="nc">MySpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="n">next_response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{</span><span class="n">response</span><span class="o">.</span><span class="n">url</span><span class="si">}</span><span class="s1">/next&#39;</span><span class="p">)</span>
        <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_next_page</span><span class="p">(</span><span class="n">next_response</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="s1">&#39;nothing&#39;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse_next_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">metadata</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
</code></pre></div>

<p>It works well, except you want to yield many coroutines in a for loop.
Look at the following pseudo-code:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">ruia</span> <span class="kn">import</span> <span class="n">Spider</span>


<span class="k">class</span> <span class="nc">MySpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;https://some.site/</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_next</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse_next</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
</code></pre></div>

<p>You will find the requests in the for loop runs in a synchronous way!
Oh, awful. To solve this problem, <code>ruia</code> provides a <code>multiple_request</code> method.
Here is an example for Github Developer Documentation.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Target: https://developer.github.com/v3/</span>
<span class="kn">from</span> <span class="nn">ruia</span> <span class="kn">import</span> <span class="o">*</span>


<span class="k">class</span> <span class="nc">CatalogueItem</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="n">target_item</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;.sidebar-menu a&#39;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">link</span> <span class="o">=</span> <span class="n">AttrField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;href&#39;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">clean_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;https://developer.github.com</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span>


<span class="k">class</span> <span class="nc">PageItem</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">HtmlField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;.content&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GithubDeveloperSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;https://developer.github.com/v3/&#39;</span><span class="p">]</span>
    <span class="n">concurrency</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
        <span class="n">catalogue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">CatalogueItem</span><span class="o">.</span><span class="n">get_items</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()):</span>
            <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">cat</span><span class="o">.</span><span class="n">link</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">catalogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
        <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="n">page</span><span class="o">.</span><span class="n">link</span> <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">catalogue</span><span class="p">][:</span><span class="mi">10</span><span class="p">]</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_request</span><span class="p">(</span><span class="n">urls</span><span class="p">,</span> <span class="n">is_gather</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">catalogue</span><span class="p">[</span><span class="n">response</span><span class="o">.</span><span class="n">index</span><span class="p">]</span><span class="o">.</span><span class="n">title</span>
            <span class="k">yield</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_page</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">title</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">title</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="k">await</span> <span class="n">PageItem</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">GithubDeveloperSpider</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>

<p>Our crawler starts with <code>start_urls</code> and <code>parse</code> method as usual.
We get a list of urls.
Then we call <code>self.multiple_request</code> method to send further requests.</p>
<p><code>multiple_request(urls, **kwargs)</code> method requires a positional argument <code>urls</code>.
It is a list of string.
It also accept any other arguments like <code>ruia.Request</code>.
Pay attention to use <code>async for</code> statement.</p>
<p><code>multiple_request</code> method returns an asynchronous generator.
It yields responses.
You may want to use enumerate to get the index of responses like this:</p>
<div class="codehilite"><pre><span></span><code><span class="k">async</span> <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
    <span class="n">urls</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s1">&#39;https://site.com/</span><span class="si">{</span><span class="n">page</span><span class="si">}</span><span class="s1">&#39;</span> <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
    <span class="k">async</span> <span class="k">for</span> <span class="n">response</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">multiple_request</span><span class="p">(</span><span class="n">urls</span><span class="p">):</span>
        <span class="k">pass</span>
</code></pre></div>

<p>Then you will get an Exception, telling you that enumerate cannot process asynchronous generator.
<code>ruia</code> provides a property for every response object: <code>response.index</code>.
It is useful when you want to pass some context to the next parsing method.
The order of responses currently is just the same as urls,
but it's an unstable feature.
Use <code>response.index</code> to get its position.</p>
<p><code>multiple_request</code> has another argument <code>is_gather</code>,
which indicates whether ruia should run the requests together or not.
If <code>is_gather=True</code>, then the requests will run together.
If not, the requests will run one by one.</p>
<p><code>is_gather=True</code> is usually better, except one condition:
we have a catalogue contains 1000 pages.
If we use <code>gather=True</code>, we will get the response after 1000 requests.
It may take too long before parsing.</p>
<h2 id="concurrency-control">Concurrency Control</h2>
<p>Let's repeat the Github Developer spider.</p>
<div class="codehilite"><pre><span></span><code><span class="c1"># Target: https://developer.github.com/v3/</span>
<span class="kn">from</span> <span class="nn">ruia</span> <span class="kn">import</span> <span class="o">*</span>


<span class="k">class</span> <span class="nc">CatalogueItem</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="n">target_item</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;.sidebar-menu a&#39;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">)</span>
    <span class="n">link</span> <span class="o">=</span> <span class="n">AttrField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;href&#39;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">clean_link</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;https://developer.github.com</span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s1">&#39;</span>


<span class="k">class</span> <span class="nc">PageItem</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="n">content</span> <span class="o">=</span> <span class="n">HtmlField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;.content&#39;</span><span class="p">)</span>


<span class="k">class</span> <span class="nc">GithubDeveloperSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;https://developer.github.com/v3/&#39;</span><span class="p">]</span>
    <span class="n">concurrency</span> <span class="o">=</span> <span class="mi">5</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
        <span class="n">catalogue</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">cat</span> <span class="ow">in</span> <span class="n">CatalogueItem</span><span class="o">.</span><span class="n">get_items</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()):</span>
            <span class="n">catalogue</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">page</span> <span class="ow">in</span> <span class="n">catalogue</span><span class="p">[:</span><span class="mi">20</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s1">&#39;#&#39;</span> <span class="ow">in</span> <span class="n">page</span><span class="o">.</span><span class="n">link</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">yield</span> <span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">page</span><span class="o">.</span><span class="n">link</span><span class="p">,</span> <span class="n">metadata</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;title&#39;</span><span class="p">:</span> <span class="n">page</span><span class="o">.</span><span class="n">title</span><span class="p">},</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_page</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse_page</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">:</span> <span class="n">Response</span><span class="p">):</span>
        <span class="n">item</span> <span class="o">=</span> <span class="k">await</span> <span class="n">PageItem</span><span class="o">.</span><span class="n">get_item</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
        <span class="n">title</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s1">&#39;title&#39;</span><span class="p">]</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">title</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">GithubDeveloperSpider</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>

<p>This time, there's a line added:</p>
<div class="codehilite"><pre><span></span><code>    <span class="n">concurrency</span> <span class="o">=</span> <span class="mi">5</span>
</code></pre></div>

<p>Here's a brief introduction about concurrency.
Some websites are friendly to crawlers,
while some are not.
If you visit a website too frequently,
you will be banned from the server.
Besides, to be a good crawler,
we should protect the server,
rather than making it crash.
Not every server can burden a huge spider.</p>
<p>To protect both, we have to control our concurrency.
Concurrency means the connection numbers in a time.
In this case, we set it to 5.</p>
<p>Let's have a short look on the log.</p>
<div class="codehilite"><pre><span></span><code>Output:
[2019:01:23 00:01:59]-ruia-INFO  spider : Spider started!
[2019:01:23 00:01:59]-ruia-WARNINGspider : ruia tried to use loop.add_signal_handler but it is not implemented on this platform.
[2019:01:23 00:01:59]-ruia-WARNINGspider : ruia tried to use loop.add_signal_handler but it is not implemented on this platform.
[2019:01:23 00:01:59]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/&gt;
[2019:01:23 00:02:00]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/&gt;
[2019:01:23 00:02:00]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/media/&gt;
[2019:01:23 00:02:00]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/oauth_authorizations/&gt;
[2019:01:23 00:02:00]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/auth/&gt;
[2019:01:23 00:02:00]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/troubleshooting/&gt;
[2019:01:23 00:02:01]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/previews/&gt;
Overview 38490
[2019:01:23 00:02:02]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/versions/&gt;
OAuth Authorizations API 66565
[2019:01:23 00:02:02]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/activity/&gt;
Media Types 8652
[2019:01:23 00:02:02]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/activity/events/&gt;
Troubleshooting 2551
[2019:01:23 00:02:02]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/activity/events/types/&gt;
API Previews 19537
[2019:01:23 00:02:02]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/activity/feeds/&gt;
Other Authentication Methods 6651
[2019:01:23 00:02:03]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/activity/notifications/&gt;
Versions 1344
Feeds 14090
[2019:01:23 00:02:03]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/activity/starring/&gt;
Activity 2178
[2019:01:23 00:02:04]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/activity/watching/&gt;
[2019:01:23 00:02:05]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/checks/&gt;
Events 11844
Starring 55228
[2019:01:23 00:02:05]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/checks/runs/&gt;
[2019:01:23 00:02:05]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/checks/suites/&gt;
Event Types &amp; Payloads 1225037
Notifications 65679
Watching 35775
Checks 7379
Check Runs 116607
[2019:01:23 00:02:06]-ruia-INFO  spider : Stopping spider: ruia
Check Suites 115330
[2019:01:23 00:02:06]-ruia-INFO  spider : Total requests: 18
[2019:01:23 00:02:06]-ruia-INFO  spider : Time usage: 0:00:07.342048
[2019:01:23 00:02:06]-ruia-INFO  spider : Spider finished!
</code></pre></div>

<p>Focus on the first several lines.</p>
<div class="codehilite"><pre><span></span><code>[2019:01:23 00:01:54]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/&gt;
[2019:01:23 00:02:00]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/&gt;
[2019:01:23 00:02:00]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/media/&gt;
[2019:01:23 00:02:00]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/oauth_authorizations/&gt;
[2019:01:23 00:02:00]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/auth/&gt;
[2019:01:23 00:02:00]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/troubleshooting/&gt;
[2019:01:23 00:02:05]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/previews/&gt;
Overview 38490
[2019:01:23 00:02:07]-Request-INFO  request: &lt;GET: https://developer.github.com/v3/versions/&gt;
OAuth Authorizations API 66565
</code></pre></div>

<p>The first request is at our requesting the catalogue page.
Then, our spider send 5 requests at almost same time, at <code>[00:02:00]</code>.
5 seconds later, at <code>[00:02:05]</code>, our spider receives a response, and then sent another request.
The response was parsed immediately.
2 seconds later, at <code>[00:02:07]</code>, our spider receives another response,
and sent another request.
Then, it parsed the response immediately.</p>
<p>That is to say,
at any time,
there are 5 connections between spider and server.
That is concurrency control.</p>
<p>Hey, notice that our spider sent 5 requests at same time!
Thanks to python's <code>asyncio</code> library,
we can write asynchronous crawler easier and faster.
Coroutines runs faster than multi-threadings.</p>
<h2 id="use-middleware">Use Middleware</h2>
<p><code>Ruia</code> provides mainly two ways to enhance itself.</p>
<p>Firstly let's talk about middlewares.
Middlewares are used to process a request before it's sending
and to process a response after it's receiving
In a word, it is something between your spider and server.</p>
<p><a href="https://github.com/ruia-plugins/ruia-ua">Here</a> is a simple middleware named <code>ruia-ua</code>,
it is used to automatically add random User-Agent to your requests.</p>
<p>Firstly, install <code>ruia-ua</code>.</p>
<div class="codehilite"><pre><span></span><code>pip install ruia-ua
</code></pre></div>

<p>Then, add it to your spider.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">ruia</span> <span class="kn">import</span> <span class="n">AttrField</span><span class="p">,</span> <span class="n">TextField</span><span class="p">,</span> <span class="n">Item</span><span class="p">,</span> <span class="n">Spider</span>
<span class="kn">from</span> <span class="nn">ruia_ua</span> <span class="kn">import</span> <span class="n">middleware</span>


<span class="k">class</span> <span class="nc">HackerNewsItem</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="n">target_item</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;tr.athing&#39;</span><span class="p">)</span>
    <span class="n">title</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;a.storylink&#39;</span><span class="p">)</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">AttrField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;a.storylink&#39;</span><span class="p">,</span> <span class="n">attr</span><span class="o">=</span><span class="s1">&#39;href&#39;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">clean_title</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">value</span>


<span class="k">class</span> <span class="nc">HackerNewsSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;https://news.ycombinator.com/news?p=1&#39;</span><span class="p">,</span> <span class="s1">&#39;https://news.ycombinator.com/news?p=2&#39;</span><span class="p">]</span>
    <span class="n">concurrency</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">res</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">HackerNewsItem</span><span class="o">.</span><span class="n">get_items</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="n">res</span><span class="o">.</span><span class="n">html</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">item</span><span class="o">.</span><span class="n">title</span><span class="p">)</span>


<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">HackerNewsSpider</span><span class="o">.</span><span class="n">start</span><span class="p">(</span><span class="n">middleware</span><span class="o">=</span><span class="n">middleware</span><span class="p">)</span>
</code></pre></div>

<p><code>ruia.Spider</code> has an argument <code>middleware</code>.
It receives a list or a single middleware.</p>
<h2 id="use-plugin">Use Plugin</h2>
<p>If you want better control of your spider,
try to use some plugins.</p>
<p><a href="https://github.com/ruia-plugins/ruia-pyppeteer">ruia-pyppeteer</a> is a <code>ruia</code> plugin used for loading JavaScript.</p>
<p>Firstly, install <code>ruia-pyppeteer</code>.</p>
<div class="codehilite"><pre><span></span><code>pip install ruia_pyppeteer
<span class="c1"># New features</span>
pip install git+https://github.com/ruia-plugins/ruia-pyppeteer
</code></pre></div>

<div class="admonition note">
<p class="admonition-title">Note</p>
<p>When you use load_js, it will download a recent version of Chromium (~100MB). This only happens once.</p>
</div>
<p>Here is a simple example to show how to load JavaScript.</p>
<div class="codehilite"><pre><span></span><code><span class="kn">import</span> <span class="nn">asyncio</span>

<span class="kn">from</span> <span class="nn">ruia_pyppeteer</span> <span class="kn">import</span> <span class="n">PyppeteerRequest</span> <span class="k">as</span> <span class="n">Request</span>

<span class="n">request</span> <span class="o">=</span> <span class="n">Request</span><span class="p">(</span><span class="s2">&quot;https://www.jianshu.com/&quot;</span><span class="p">,</span> <span class="n">load_js</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">response</span> <span class="o">=</span> <span class="n">asyncio</span><span class="o">.</span><span class="n">get_event_loop</span><span class="p">()</span><span class="o">.</span><span class="n">run_until_complete</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">fetch</span><span class="p">())</span>
<span class="nb">print</span><span class="p">(</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">())</span>
</code></pre></div>

<p>Here is an example to use it in your spider:</p>
<div class="codehilite"><pre><span></span><code><span class="kn">from</span> <span class="nn">ruia</span> <span class="kn">import</span> <span class="n">AttrField</span><span class="p">,</span> <span class="n">TextField</span><span class="p">,</span> <span class="n">Item</span>

<span class="kn">from</span> <span class="nn">ruia_pyppeteer</span> <span class="kn">import</span> <span class="n">PyppeteerSpider</span> <span class="k">as</span> <span class="n">Spider</span>
<span class="kn">from</span> <span class="nn">ruia_pyppeteer</span> <span class="kn">import</span> <span class="n">PyppeteerRequest</span> <span class="k">as</span> <span class="n">Request</span>


<span class="k">class</span> <span class="nc">JianshuItem</span><span class="p">(</span><span class="n">Item</span><span class="p">):</span>
    <span class="n">target_item</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;ul.list&gt;li&#39;</span><span class="p">)</span>
    <span class="n">author_name</span> <span class="o">=</span> <span class="n">TextField</span><span class="p">(</span><span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;a.name&#39;</span><span class="p">)</span>
    <span class="n">author_url</span> <span class="o">=</span> <span class="n">AttrField</span><span class="p">(</span><span class="n">attr</span><span class="o">=</span><span class="s1">&#39;href&#39;</span><span class="p">,</span> <span class="n">css_select</span><span class="o">=</span><span class="s1">&#39;a.name&#39;</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">clean_author_url</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">author_url</span><span class="p">):</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s2">&quot;https://www.jianshu.com</span><span class="si">{</span><span class="n">author_url</span><span class="si">}</span><span class="s2">&quot;</span>


<span class="k">class</span> <span class="nc">JianshuSpider</span><span class="p">(</span><span class="n">Spider</span><span class="p">):</span>
    <span class="n">start_urls</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;https://www.jianshu.com/&#39;</span><span class="p">]</span>
    <span class="n">concurrency</span> <span class="o">=</span> <span class="mi">10</span>
    <span class="c1"># Load js on the first request</span>
    <span class="n">load_js</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="k">async</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">JianshuItem</span><span class="o">.</span><span class="n">get_items</span><span class="p">(</span><span class="n">html</span><span class="o">=</span><span class="k">await</span> <span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">()):</span>
            <span class="c1"># Loading js by using PyppeteerRequest</span>
            <span class="k">yield</span> <span class="n">Request</span><span class="p">(</span><span class="n">url</span><span class="o">=</span><span class="n">item</span><span class="o">.</span><span class="n">author_url</span><span class="p">,</span> <span class="n">load_js</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">load_js</span><span class="p">,</span> <span class="n">callback</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">parse_item</span><span class="p">)</span>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">parse_item</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">JianshuSpider</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</code></pre></div>
                
              
              
                


              
            </article>
          </div>
        </div>
        
      </main>
      
        
<footer class="md-footer">
  
    <nav class="md-footer__inner md-grid" aria-label="Footer">
      
        
        <a href="item.html" class="md-footer__link md-footer__link--prev" aria-label="Previous: 3. Define Data Items" rel="prev">
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg>
          </div>
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Previous
              </span>
              3. Define Data Items
            </div>
          </div>
        </a>
      
      
        
        <a href="request.html" class="md-footer__link md-footer__link--next" aria-label="Next: 5. Request &amp; Response" rel="next">
          <div class="md-footer__title">
            <div class="md-ellipsis">
              <span class="md-footer__direction">
                Next
              </span>
              5. Request & Response
            </div>
          </div>
          <div class="md-footer__button md-icon">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg>
          </div>
        </a>
      
    </nav>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            Copyright &copy; 2018 - 2021 <a href="https://github.com/howie6879/ruia">howie.hu</a>.
          </div>
        
        
          Made with
          <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
            Material for MkDocs
          </a>
        
        
      </div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    <script id="__config" type="application/json">{"base": "../..", "features": [], "translations": {"clipboard.copy": "Copy to clipboard", "clipboard.copied": "Copied to clipboard", "search.config.lang": "en", "search.config.pipeline": "trimmer, stopWordFilter", "search.config.separator": "[\\s\\-]+", "search.placeholder": "Search", "search.result.placeholder": "Type to start searching", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing", "select.version.title": "Select version"}, "search": "../../assets/javascripts/workers/search.8397ff9e.min.js", "version": null}</script>
    
    
      <script src="../../assets/javascripts/bundle.1e84347e.min.js"></script>
      
    
  </body>
</html>